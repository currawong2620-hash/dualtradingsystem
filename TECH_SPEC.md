## üìÑ `TECH_SPEC.md` ‚Äî *Dual-Mode Forex Trading System (v1.1)*

### 1. Overview

**–¶–µ–ª—å:** —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç–æ—Ä–≥–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è MetaTrader 5 (MQL5),
–∫–æ—Ç–æ—Ä–∞—è –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ —Ä—ã–Ω–æ—á–Ω—ã–º —Ñ–∞–∑–∞–º, –ø–µ—Ä–µ–∫–ª—é—á–∞—è—Å—å –º–µ–∂–¥—É –¥–≤—É–º—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏:

* **Trend Engine** ‚Äî —Å–ª–µ–¥—É–µ—Ç –∑–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –¥–≤–∏–∂–µ–Ω–∏–µ–º;
* **Range Engine** ‚Äî —Ç–æ—Ä–≥—É–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç—ã –∫ —Å—Ä–µ–¥–Ω–µ–º—É –≤ –∫–∞–Ω–∞–ª–µ.

**–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è:** —Ä—ã–Ω–æ–∫ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä—à–µ–º —Ç–∞–π–º—Ñ—Ä–µ–π–º–µ (H1), —Ç–æ—Ä–≥–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –Ω–∞ —Ä–∞–±–æ—á–µ–º (M5).

#### 1.1 Assumptions & Constraints

| –ü–∞—Ä–∞–º–µ—Ç—Ä                                | –ó–Ω–∞—á–µ–Ω–∏–µ / –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ                                                                |
| --------------------------------------- | ------------------------------------------------------------------------------------- |
| –¶–µ–ª–µ–≤—ã–µ –ø–∞—Ä—ã                            | EURUSD, GBPUSD, USDJPY, XAUUSD                                                        |
| –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å                      | ‚â• 1000 USD (0.01 –ª–æ—Ç, ECN-—Å—á—ë—Ç)                                                       |
| –ú–∞–∫—Å–∏–º—É–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ | 3                                                                                     |
| –°–ø—Ä—ç–¥                                   | ‚â§ 2 –ø—É–Ω–∫—Ç–∞ (majors)                                                                   |
| –•–µ–¥–∂–∏–Ω–≥                                 | –†–∞–∑—Ä–µ—à—ë–Ω                                                                              |
| –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å                         | –°–∏—Å—Ç–µ–º–∞ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∏–±—ã–ª—å; —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ä—ã–Ω–æ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏. |

---

### 2. Market Regime Detection (Mode Analyzer)

**–ú–µ—Ç—Ä–∏–∫–∏:**

* ADX (14) ‚Äî –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ—Å—Ç—å (–≤–µ—Å 0.4)
* ATR (14) ‚Äî –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (0.3)
* STD (20) ‚Äî –¥–∏—Å–ø–µ—Ä—Å–∏—è (0.2)
* EMA-slope (50) ‚Äî —É–≥–æ–ª –Ω–∞–∫–ª–æ–Ω–∞ (0.1)
* BB width (20, 2) ‚Äî —à–∏—Ä–∏–Ω–∞ –∫–∞–Ω–∞–ª–∞ (–¥–æ–ø. —Ñ–∏–ª—å—Ç—Ä)

**–ü–æ—Ä–æ–≥–∏ (defaults):**

```
ADX_Thr_L = 17
ADX_Thr_H = 25
Slope_Thr  = 0.1
N_confirm  = 3
```

**–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (–Ω–∞ H1):**

* `TREND_UP` / `TREND_DOWN` ‚Äî ADX > 25 –∏ |slope| > 0.1
* `RANGE` ‚Äî ADX < 17 –∏ |bias| < thr_bias
* `TRANSITION` ‚Äî –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –∑–æ–Ω–∞ (pause mode)

**Bias-–º–æ–¥–µ–ª—å:**
[
bias = w_1¬∑norm(ADX)+w_2¬∑norm(ATR)+w_3¬∑norm(STD)+w_4¬∑norm(slope)
]
[
Œº = EMA(bias),\quad œÉ = EMA(|bias-Œº|)
]
[
confidence = |bias| / (œÉ+Œµ)
]

**FSM-–ª–æ–≥–∏–∫–∞:**
–ü–µ—Ä–µ—Ö–æ–¥ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ N_confirm –±–∞—Ä–æ–≤ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.
–í—Å–µ —Å–º–µ–Ω—ã TREND‚ÜîRANGE –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ TRANSITION.

---

### 3. Trend Engine

* **TF:** M5
* **–í—Ö–æ–¥—ã:**

  * Breakout Donchian(20) + ADX_H1 > 25
  * EMA(50) > EMA(200) –¥–ª—è long / –æ–±—Ä–∞—Ç–Ω–æ–µ –¥–ª—è short
  * RSI < 80 –¥–ª—è long, > 20 –¥–ª—è short
  * ATR > —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–∞ 50 –±–∞—Ä–æ–≤
* **–í—ã—Ö–æ–¥—ã:** TP/SL = k¬∑ATR ( SL = 1.8, TP ‚âà 3.0 √ó ATR )
* **Trailing:** –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π ATR-—Ç—Ä–µ–π–ª–∏–Ω–≥
* **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–µ–π:** Pyramiding (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ profit > 1 ATR –∏ conf > 0.7)
* **–ù–æ–≤–æ—Å—Ç–∏:** –ø–∞—É–∑–∞ –∑–∞ 30 –º–∏–Ω –¥–æ/–ø–æ—Å–ª–µ High-impact (–∏–∑ CSV —Ñ–∞–π–ª–∞ –∏–ª–∏ MQL5 Calendar API)
* **Risk per trade:** ‚â§ 1 % –æ—Ç TrendCapital

---

### 4. Range Engine

* **TF:** M5
* **–í—Ö–æ–¥—ã:**

  * Long: —Ü–µ–Ω–∞ ‚â§ –Ω–∏–∂–Ω—è—è BB(20, 2), RSI < 30, ADX_H1 < 17
  * Short: —Ü–µ–Ω–∞ ‚â• –≤–µ—Ä—Ö–Ω—è—è BB(20, 2), RSI > 70
  * BB width < —Å—Ä–µ–¥–Ω–µ–≥–æ ‚Üí –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–ª—ç—Ç
* **–í—ã—Ö–æ–¥:** TP = Œ±¬∑BBw ( Œ± = 0.6 ), SL = 1.2¬∑ATR
* **–§–∏–ª—å—Ç—Ä:** –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –≤—Ö–æ–¥–æ–≤ –ø—Ä–∏ ADX > 25
* **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:** –æ–ø—Ü–∏—è –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏ MACD (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é off)
* **Risk per trade:** ‚â§ 0.5 % –æ—Ç RangeCapital

---

### 5. Mode Switch Mechanism (FSM)

| State      | –î–µ–π—Å—Ç–≤–∏–µ                      | –û–±—ä—ë–º            |
| ---------- | ----------------------------- | ---------------- |
| TREND      | –ê–∫—Ç–∏–≤–µ–Ω Trend Engine          | Vtrend √ó f(conf) |
| RANGE      | –ê–∫—Ç–∏–≤–µ–Ω Range Engine          | Vrange √ó f(conf) |
| TRANSITION | –¢–æ—Ä–≥–æ–≤–ª—è –ø–∞—É–∑–∞ ( M = 3 –±–∞—Ä–∞ ) | 0                |

**f(conf)** = `min(1.0, confidence √ó 1.2)`
**Debounce**: —Å–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ N_confirm –±–∞—Ä–æ–≤.

---

### 6. Risk Management

* **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞:** Trend 60 %, Range 40 %
* **–î–Ω–µ–≤–Ω–æ–π —Ä–∏—Å–∫-–ª–∏–º–∏—Ç:** ‚â§ 2.5 % –¥–µ–ø–æ–∑–∏—Ç–∞
* **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π DD:** 20 % (–∞–≤—Ç–æ-–æ—Å—Ç–∞–Ω–æ–≤–∫–∞)
* **–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è:** œÅ > 0.7 ‚Üí –∑–∞–ø—Ä–µ—Ç –≤—Ç–æ—Ä–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
* **–°–µ—Å—Å–∏–∏:** Asia ‚Äî –æ—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π –æ–±—ä—ë–º; London/NY ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è
* **Slippage & Commissions:** —Å–∏–º—É–ª—è—Ü–∏—è –≤ `Trade_Simulator.mqh` (Œº = 1 –ø–∏–ø, œÉ = 0.5)
* **Error-Handling:** retry –ø—Ä–∏ CopyBuffer / trade timeout; –ª–æ–≥ –≤ CSV

---

### 7. Architecture & Modules

| –ú–æ–¥—É–ª—å                  | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                         |
| ----------------------- | -------------------------------------------------- |
| **TFContext.mqh**       | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (ADX, ATR, EMA, BB, RSI) |
| **Forecast.mqh**        | –†–∞—Å—á—ë—Ç Œº, œÉ, bias, confidence                      |
| **ModeAnalyzer.mqh**    | FSM –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤                          |
| **TrendEngine.mqh**     | –õ–æ–≥–∏–∫–∞ —Ç—Ä–µ–Ω–¥–æ–≤—ã—Ö –≤—Ö–æ–¥–æ–≤ / –≤—ã—Ö–æ–¥–æ–≤                  |
| **RangeEngine.mqh**     | –õ–æ–≥–∏–∫–∞ —Ñ–ª—ç—Ç–æ–≤—ã—Ö –≤—Ö–æ–¥–æ–≤ / –≤—ã—Ö–æ–¥–æ–≤                   |
| **TradeManager.mqh**    | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–∞–º–∏, –ª–æ—Ç–æ–º, —Ä–∏—Å–∫–æ–º                 |
| **Trade_Simulator.mqh** | –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∏ slippage                |
| **Stats.mqh**           | PF, Sharpe, avgR, PnL –ø–æ —Ä–µ–∂–∏–º–∞–º                   |
| **Panel_Main.mqh**      | UI: —Ä–µ–∂–∏–º, confidence, equity, DD                  |
| **Logging.mqh**         | –£—Ä–æ–≤–Ω–µ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ç–∞–π–º-—Å—Ç–µ–º–ø–∞–º–∏              |

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
`ModeAnalyzer ‚Üí Forecast ‚Üí TFContext` (–¥–∞–Ω–Ω—ã–µ) ‚Üí `Engines` ‚Üí `TradeManager`.

---

### 8. Backtesting & Evaluation

* **–î–∞–Ω–Ω—ã–µ:** —Ç–∏–∫-–∏—Å—Ç–æ—Ä–∏—è 2015‚Äì2025 (Dukascopy –∏–ª–∏ –±—Ä–æ–∫–µ—Ä ECN)
* **–ú–µ—Ç—Ä–∏–∫–∏:**

  * Profit Factor ‚â• 1.35
  * Sharpe ‚â• 0.8
  * Max DD ‚â§ 20 %
  * PF_trend ‚â• 1.5; PF_range ‚â• 1.25
* **Walk-Forward:** –ø–µ—Ä–∏–æ–¥—ã –ø–æ –∫–≤–∞—Ä—Ç–∞–ª–∞–º
* **OOS:** ‚â• 30 % –¥–∞–Ω–Ω—ã—Ö
* **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:** Monte-Carlo sim (1000 –∏—Ç–µ—Ä–∞—Ü–∏–π) –¥–ª—è robustness
* **–û—Ç—á—ë—Ç:** —Ä–∞–∑–¥–µ–ª—å–Ω—ã–π –ø–æ —Ä–µ–∂–∏–º–∞–º –∏ —Å–µ—Å—Å–∏—è–º

---

### 9. Implementation

* **–Ø–∑—ã–∫:** MQL5 (strict)
* **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** MT5 build ‚â• 3900 / ECN —Å—á–µ—Ç–∞ / hedging allowed
* **–°—Ä–µ–¥–∞:** Windows 10/11 + MetaEditor
* **–õ–æ–≥–∏:** –≤ `/Logs/EA/` (–ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∏ –ø–æ –¥–Ω—è–º)
* **–¢–µ—Å—Ç:** —Å–Ω–∞—á–∞–ª–∞ demo, –ø–æ—Ç–æ–º real —Å 0.01 –ª–æ—Ç–∞–º–∏
* **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** ADX/ATR –ø–æ—Ä–æ–≥–∏, N_confirm, SL/TP –º–Ω–æ–∂–∏—Ç–µ–ª–∏

---

### 10. Future Extensions

1. **News Module (core):** –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—é (FF API –∏–ª–∏ MQL5 Calendar).
2. **ML ModeAnalyzer (v2.0):** SVM / Random Forest –Ω–∞ –≤–µ–∫—Ç–æ—Ä–µ [ADX, ATR, STD, RSI].
3. **Multi-symbol portfolio:** –æ–±—â–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Ä–∏—Å–∫–∞ –º–µ–∂–¥—É –ø–∞—Ä–∞–º–∏.
4. **Self-optimization:** Œº¬±œÉ-–ø—Ä–æ—Ñ–∏–ª–∏ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∫–∏.

---

### 11. Revised Evaluation Targets (v1.1)

| –ú–µ—Ç—Ä–∏–∫–∞       | –¶–µ–ª—å                             |
| ------------- | -------------------------------- |
| Sharpe Ratio  | ‚â• 0.8                            |
| Profit Factor | ‚â• 1.35                           |
| Max Drawdown  | ‚â§ 20 %                           |
| Hit Rate      | ‚âà 45‚Äì60 % (–Ω–µ —Ü–µ–ª—å —Å–∞–º–æ –ø–æ —Å–µ–±–µ) |
| Avg R:R       | ‚â• 1.8 : 1                        |

---

¬© 2025 Dual-Mode Forex Project
–î–æ–∫—É–º–µ–Ω—Ç v1.1 ‚Äî —É—Ç–≤–µ—Ä–∂–¥—ë–Ω –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —è–¥—Ä–∞ EA.
